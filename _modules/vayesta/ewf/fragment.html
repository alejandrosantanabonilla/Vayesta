<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>vayesta.ewf.fragment &mdash; Vayesta 1.0.0 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> Vayesta
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart/index.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/index.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apidoc/modules.html">API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Vayesta</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
          <li><a href="../../vayesta.html">vayesta</a> &raquo;</li>
          <li><a href="../ewf.html">vayesta.ewf</a> &raquo;</li>
      <li>vayesta.ewf.fragment</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for vayesta.ewf.fragment</h1><div class="highlight"><pre>
<span></span><span class="c1"># Standard libaries</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">dataclasses</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>

<span class="c1"># External libaries</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># Internal libaries</span>
<span class="kn">import</span> <span class="nn">pyscf</span>
<span class="kn">import</span> <span class="nn">pyscf.pbc</span>
<span class="kn">import</span> <span class="nn">pyscf.cc</span>

<span class="c1"># Local modules</span>
<span class="kn">import</span> <span class="nn">vayesta</span>
<span class="kn">from</span> <span class="nn">vayesta.core.util</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">vayesta.core.qemb</span> <span class="kn">import</span> <span class="n">Fragment</span> <span class="k">as</span> <span class="n">BaseFragment</span>
<span class="kn">from</span> <span class="nn">vayesta.solver</span> <span class="kn">import</span> <span class="n">get_solver_class</span>
<span class="kn">from</span> <span class="nn">vayesta.core.fragmentation</span> <span class="kn">import</span> <span class="n">IAO_Fragmentation</span>
<span class="kn">from</span> <span class="nn">vayesta.core.types</span> <span class="kn">import</span> <span class="n">RFCI_WaveFunction</span>

<span class="kn">from</span> <span class="nn">vayesta.core.bath</span> <span class="kn">import</span> <span class="n">BNO_Threshold</span>
<span class="kn">from</span> <span class="nn">vayesta.core.bath</span> <span class="kn">import</span> <span class="n">DMET_Bath</span>
<span class="kn">from</span> <span class="nn">vayesta.core.types</span> <span class="kn">import</span> <span class="n">Orbitals</span>
<span class="kn">from</span> <span class="nn">vayesta.core</span> <span class="kn">import</span> <span class="n">ao2mo</span>
<span class="kn">from</span> <span class="nn">vayesta.mpi</span> <span class="kn">import</span> <span class="n">mpi</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">ewf</span>


<span class="c1"># Get MPI rank of fragment</span>
<span class="n">get_fragment_mpi_rank</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span> <span class="p">:</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mpi_rank</span>


<div class="viewcode-block" id="Options"><a class="viewcode-back" href="../../../apidoc/vayesta.ewf.html#vayesta.ewf.ewf.Options">[docs]</a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">Options</span><span class="p">(</span><span class="n">BaseFragment</span><span class="o">.</span><span class="n">Options</span><span class="p">):</span>
    <span class="c1"># Inherited from Embedding</span>
    <span class="c1"># ------------------------</span>
    <span class="c1"># --- Couple embedding problems (currently only CCSD and MPI)</span>
    <span class="n">coupled_iterations</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">t_as_lambda</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span>                <span class="c1"># If True, use T-amplitudes inplace of Lambda-amplitudes</span>
    <span class="n">bsse_correction</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">bsse_rmax</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sc_mode</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">nelectron_target</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>            <span class="c1"># If set, adjust bath chemical potential until electron number in fragment equals nelectron_target</span>
    <span class="c1"># Calculation modes</span>
    <span class="n">calc_e_wf_corr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">calc_e_dm_corr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># Fragment specific</span>
    <span class="c1"># -----------------</span>
    <span class="n">wf_factor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># TODO: move these:</span>
    <span class="c1"># CAS methods</span>
    <span class="n">c_cas_occ</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">c_cas_vir</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># --- Solver options</span>
    <span class="n">tcc_fci_opts</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span></div>


<div class="viewcode-block" id="Fragment"><a class="viewcode-back" href="../../../apidoc/vayesta.ewf.html#vayesta.ewf.ewf.Fragment">[docs]</a><span class="k">class</span> <span class="nc">Fragment</span><span class="p">(</span><span class="n">BaseFragment</span><span class="p">):</span>

    <span class="n">Options</span> <span class="o">=</span> <span class="n">Options</span>

<div class="viewcode-block" id="Fragment.Flags"><a class="viewcode-back" href="../../../apidoc/vayesta.ewf.html#vayesta.ewf.ewf.Fragment.Flags">[docs]</a>    <span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span>
    <span class="k">class</span> <span class="nc">Flags</span><span class="p">(</span><span class="n">BaseFragment</span><span class="o">.</span><span class="n">Flags</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Fragment.Results"><a class="viewcode-back" href="../../../apidoc/vayesta.ewf.html#vayesta.ewf.ewf.Fragment.Results">[docs]</a>    <span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span>
    <span class="k">class</span> <span class="nc">Results</span><span class="p">(</span><span class="n">BaseFragment</span><span class="o">.</span><span class="n">Results</span><span class="p">):</span>
        <span class="n">e_corr_dm2cumulant</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">n_active</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ip_energy</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ea_energy</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="nd">@property</span>
        <span class="k">def</span> <span class="nf">dm1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Cluster 1DM&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wf</span><span class="o">.</span><span class="n">make_rdm1</span><span class="p">()</span>

        <span class="nd">@property</span>
        <span class="k">def</span> <span class="nf">dm2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Cluster 2DM&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wf</span><span class="o">.</span><span class="n">make_rdm2</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        base : EWF</span>
<span class="sd">            Base EWF object.</span>
<span class="sd">        fid : int</span>
<span class="sd">            Unique ID of fragment.</span>
<span class="sd">        name :</span>
<span class="sd">            Name of fragment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># For self-consistent mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver_results</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="Fragment.reset"><a class="viewcode-back" href="../../../apidoc/vayesta.ewf.html#vayesta.ewf.ewf.Fragment.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tailor_fragments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tailor_project</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Fragment.set_cas"><a class="viewcode-back" href="../../../apidoc/vayesta.ewf.html#vayesta.ewf.ewf.Fragment.set_cas">[docs]</a>    <span class="k">def</span> <span class="nf">set_cas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iaos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">c_occ</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">c_vir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">minao</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">dmet_threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set complete active space for tailored CCSD&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dmet_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dmet_threshold</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">bath_options</span><span class="p">[</span><span class="s1">&#39;dmet_threshold&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">iaos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Create new IAO fragmentation</span>
            <span class="n">frag</span> <span class="o">=</span> <span class="n">IAO_Fragmentation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">,</span> <span class="n">minao</span><span class="o">=</span><span class="n">minao</span><span class="p">)</span>
            <span class="n">frag</span><span class="o">.</span><span class="n">kernel</span><span class="p">()</span>
            <span class="c1"># Get IAO and environment coefficients from fragmentation</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">frag</span><span class="o">.</span><span class="n">get_orbital_fragment_indices</span><span class="p">(</span><span class="n">iaos</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">c_iao</span> <span class="o">=</span> <span class="n">frag</span><span class="o">.</span><span class="n">get_frag_coeff</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
            <span class="n">c_env</span> <span class="o">=</span> <span class="n">frag</span><span class="o">.</span><span class="n">get_env_coeff</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
            <span class="n">bath</span> <span class="o">=</span> <span class="n">DMET_Bath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dmet_threshold</span><span class="o">=</span><span class="n">dmet_threshold</span><span class="p">)</span>
            <span class="n">c_dmet</span> <span class="o">=</span> <span class="n">bath</span><span class="o">.</span><span class="n">make_dmet_bath</span><span class="p">(</span><span class="n">c_env</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">c_iao_occ</span><span class="p">,</span> <span class="n">c_iao_vir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagonalize_cluster_dm</span><span class="p">(</span><span class="n">c_iao</span><span class="p">,</span> <span class="n">c_dmet</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">dmet_threshold</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c_iao_occ</span> <span class="o">=</span> <span class="n">c_iao_vir</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">c_cas_occ</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">(</span><span class="n">c_occ</span><span class="p">,</span> <span class="n">c_iao_occ</span><span class="p">)</span>
        <span class="n">c_cas_vir</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">(</span><span class="n">c_vir</span><span class="p">,</span> <span class="n">c_iao_vir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">c_cas_occ</span> <span class="o">=</span> <span class="n">c_cas_occ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">c_cas_vir</span> <span class="o">=</span> <span class="n">c_cas_vir</span>
        <span class="k">return</span> <span class="n">c_cas_occ</span><span class="p">,</span> <span class="n">c_cas_vir</span></div>

<div class="viewcode-block" id="Fragment.tailor_with_fragments"><a class="viewcode-back" href="../../../apidoc/vayesta.ewf.html#vayesta.ewf.ewf.Fragment.tailor_with_fragments">[docs]</a>    <span class="k">def</span> <span class="nf">tailor_with_fragments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fragments</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">!=</span> <span class="s1">&#39;CCSD&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tailor_fragments</span> <span class="o">=</span> <span class="n">fragments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tailor_project</span> <span class="o">=</span> <span class="n">project</span></div>

<div class="viewcode-block" id="Fragment.get_init_guess"><a class="viewcode-back" href="../../../apidoc/vayesta.ewf.html#vayesta.ewf.ewf.Fragment.get_init_guess">[docs]</a>    <span class="k">def</span> <span class="nf">get_init_guess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">init_guess</span><span class="p">,</span> <span class="n">solver</span><span class="p">,</span> <span class="n">cluster</span><span class="p">):</span>
        <span class="c1"># FIXME</span>
        <span class="k">return</span> <span class="p">{}</span></div>
        <span class="c1"># --- Project initial guess and integrals from previous cluster calculation with smaller eta:</span>
        <span class="c1"># Use initial guess from previous calculations</span>
        <span class="c1"># For self-consistent calculations, we can restart calculation:</span>
        <span class="c1">#if init_guess is None and &#39;ccsd&#39; in solver.lower():</span>
        <span class="c1">#    if self.base.opts.sc_mode and self.base.iteration &gt; 1:</span>
        <span class="c1">#        self.log.debugv(&quot;Restarting using T1,T2 from previous iteration&quot;)</span>
        <span class="c1">#        init_guess = {&#39;t1&#39; : self.results.t1, &#39;t2&#39; : self.results.t2}</span>
        <span class="c1">#    elif self.base.opts.project_init_guess and self.results.t2 is not None:</span>
        <span class="c1">#        self.log.debugv(&quot;Restarting using projected previous T1,T2&quot;)</span>
        <span class="c1">#        # Projectors for occupied and virtual orbitals</span>
        <span class="c1">#        p_occ = dot(self.c_active_occ.T, self.base.get_ovlp(), cluster.c_active_occ)</span>
        <span class="c1">#        p_vir = dot(self.c_active_vir.T, self.base.get_ovlp(), cluster.c_active_vir)</span>
        <span class="c1">#        #t1, t2 = init_guess.pop(&#39;t1&#39;), init_guess.pop(&#39;t2&#39;)</span>
        <span class="c1">#        t1, t2 = helper.transform_amplitudes(self.results.t1, self.results.t2, p_occ, p_vir)</span>
        <span class="c1">#        init_guess = {&#39;t1&#39; : t1, &#39;t2&#39; : t2}</span>
        <span class="c1">#if init_guess is None: init_guess = {}</span>
        <span class="c1">#return init_guess</span>

    <span class="c1">#def kernel(self, bno_threshold=None, bno_threshold_occ=None, bno_threshold_vir=None, solver=None, init_guess=None, eris=None):</span>
        <span class="c1">#&quot;&quot;&quot;Run solver for a single BNO threshold.</span>

        <span class="c1">#Parameters</span>
        <span class="c1">#----------</span>
        <span class="c1">#bno_threshold : float, optional</span>
        <span class="c1">#    Bath natural orbital (BNO) threshold.</span>
        <span class="c1">#solver : {&#39;MP2&#39;, &#39;CISD&#39;, &#39;CCSD&#39;, &#39;FCI&#39;}, optional</span>
        <span class="c1">#    Correlated solver.</span>

        <span class="c1">#Returns</span>
        <span class="c1">#-------</span>
        <span class="c1">#results : self.Results</span>
        <span class="c1">#&quot;&quot;&quot;</span>
        <span class="c1">#if bno_threshold is None:</span>
        <span class="c1">#    bno_threshold = self.opts.bno_threshold</span>
        <span class="c1">#if bno_threshold_occ is None:</span>
        <span class="c1">#    bno_threshold_occ = self.opts.bno_threshold_occ</span>
        <span class="c1">#if bno_threshold_vir is None:</span>
        <span class="c1">#    bno_threshold_vir = self.opts.bno_threshold_vir</span>

        <span class="c1">#bno_threshold = BNO_Threshold(self.opts.bno_truncation, bno_threshold)</span>

        <span class="c1">#if bno_threshold_occ is not None:</span>
        <span class="c1">#    bno_threshold_occ = BNO_Threshold(self.opts.bno_truncation, bno_threshold_occ)</span>
        <span class="c1">#if bno_threshold_vir is not None:</span>
        <span class="c1">#    bno_threshold_vir = BNO_Threshold(self.opts.bno_truncation, bno_threshold_vir)</span>

        <span class="c1">#if solver is None:</span>
        <span class="c1">#    solver = self.solver</span>
        <span class="c1">#if self.bath is None:</span>
        <span class="c1">#    self.make_bath()</span>

        <span class="c1">#cluster = self.make_cluster(self.bath, bno_threshold=bno_threshold,</span>
        <span class="c1">#        bno_threshold_occ=bno_threshold_occ, bno_threshold_vir=bno_threshold_vir)</span>
        <span class="c1">#cluster.log_sizes(self.log.info, header=&quot;Orbitals for %s with %s&quot; % (self, bno_threshold))</span>

        <span class="c1">#if mpi:</span>
        <span class="c1">#    self.base.communicate_clusters()</span>

<div class="viewcode-block" id="Fragment.kernel"><a class="viewcode-back" href="../../../apidoc/vayesta.ewf.html#vayesta.ewf.ewf.Fragment.kernel">[docs]</a>    <span class="k">def</span> <span class="nf">kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">init_guess</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eris</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="n">solver</span> <span class="o">=</span> <span class="n">solver</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span>
        <span class="k">if</span> <span class="n">solver</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">valid_solvers</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown solver: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">solver</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span>
        <span class="n">cluster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span>

        <span class="c1"># For self-consistent calculations, we can reuse ERIs:</span>
        <span class="k">if</span> <span class="n">eris</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">eris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eris</span>
        <span class="c1">#if (eris is not None) and (eris.mo_coeff.size &gt; cluster.c_active.size):</span>
        <span class="c1">#    self.log.debugv(&quot;Projecting ERIs onto subspace&quot;)</span>
        <span class="c1">#    eris = ao2mo.helper.project_ccsd_eris(eris, cluster.c_active, cluster.nocc_active, ovlp=self.base.get_ovlp())</span>

        <span class="k">if</span> <span class="n">solver</span> <span class="o">==</span> <span class="s1">&#39;HF&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">init_guess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_init_guess</span><span class="p">(</span><span class="n">init_guess</span><span class="p">,</span> <span class="n">solver</span><span class="p">,</span> <span class="n">cluster</span><span class="p">)</span>

        <span class="c1"># Create solver object</span>
        <span class="n">solver_cls</span> <span class="o">=</span> <span class="n">get_solver_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="p">,</span> <span class="n">solver</span><span class="p">)</span>
        <span class="n">solver_opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_solver_options</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span>
        <span class="n">cluster_solver</span> <span class="o">=</span> <span class="n">solver_cls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">cluster</span><span class="p">,</span> <span class="o">**</span><span class="n">solver_opts</span><span class="p">)</span>

        <span class="c1"># --- Chemical potential</span>
        <span class="n">cpt_frag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">global_frag_chempot</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">nelectron_target</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cluster_solver</span><span class="o">.</span><span class="n">optimize_cpt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">nelectron_target</span><span class="p">,</span> <span class="n">c_frag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">c_proj</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">cpt_frag</span><span class="p">:</span>
            <span class="c1"># Add chemical potential to fragment space</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_overlap</span><span class="p">(</span><span class="s1">&#39;cluster|frag&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">is_rhf</span><span class="p">:</span>
                <span class="n">p_frag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                <span class="n">cluster_solver</span><span class="o">.</span><span class="n">v_ext</span> <span class="o">=</span> <span class="n">cpt_frag</span> <span class="o">*</span> <span class="n">p_frag</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p_frag</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
                <span class="n">cluster_solver</span><span class="o">.</span><span class="n">v_ext</span> <span class="o">=</span> <span class="p">(</span><span class="n">cpt_frag</span> <span class="o">*</span> <span class="n">p_frag</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cpt_frag</span> <span class="o">*</span> <span class="n">p_frag</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># --- Coupled fragments</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">coupled_iterations</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">solver</span> <span class="o">!=</span> <span class="s1">&#39;CCSD&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">mpi</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;coupled_iterations requires MPI.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">fragments</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mpi</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;coupled_iterations requires as many MPI processes as there are fragments.&quot;</span><span class="p">)</span>
            <span class="n">cluster_solver</span><span class="o">.</span><span class="n">couple_iterations</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">fragments</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">eris</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">eris</span> <span class="o">=</span> <span class="n">cluster_solver</span><span class="o">.</span><span class="n">get_eris</span><span class="p">()</span>
        <span class="c1"># Normal solver</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">_debug_wf</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">log_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;Time for </span><span class="si">%s</span><span class="s2"> solver:&quot;</span> <span class="o">%</span> <span class="n">solver</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">screening</span><span class="p">:</span>
                    <span class="n">cluster_solver</span><span class="o">.</span><span class="n">kernel</span><span class="p">(</span><span class="n">eris</span><span class="o">=</span><span class="n">eris</span><span class="p">,</span> <span class="n">seris_ov</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_seris_ov</span><span class="p">,</span> <span class="o">**</span><span class="n">init_guess</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cluster_solver</span><span class="o">.</span><span class="n">kernel</span><span class="p">(</span><span class="n">eris</span><span class="o">=</span><span class="n">eris</span><span class="p">,</span> <span class="o">**</span><span class="n">init_guess</span><span class="p">)</span>
        <span class="c1"># Special debug &quot;solver&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">_debug_wf</span> <span class="o">==</span> <span class="s1">&#39;random&#39;</span><span class="p">:</span>
                <span class="n">cluster_solver</span><span class="o">.</span><span class="n">_debug_random_wf</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cluster_solver</span><span class="o">.</span><span class="n">_debug_exact_wf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">_debug_wf</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">solver</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;dump&#39;</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">wf_factor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cluster_solver</span><span class="o">.</span><span class="n">wf</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">wf_factor</span><span class="p">)</span>

        <span class="c1"># ---Make T-projected WF</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cluster_solver</span><span class="o">.</span><span class="n">wf</span><span class="p">,</span> <span class="n">RFCI_WaveFunction</span><span class="p">):</span>
            <span class="n">pwf</span> <span class="o">=</span> <span class="n">cluster_solver</span><span class="o">.</span><span class="n">wf</span><span class="o">.</span><span class="n">as_cisd</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pwf</span> <span class="o">=</span> <span class="n">cluster_solver</span><span class="o">.</span><span class="n">wf</span>
        <span class="n">proj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_overlap</span><span class="p">(</span><span class="s1">&#39;frag|cluster-occ&#39;</span><span class="p">)</span>
        <span class="n">pwf</span> <span class="o">=</span> <span class="n">pwf</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">proj</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># --- Add to results data class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_results</span> <span class="o">=</span> <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="p">(</span><span class="n">fid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">n_active</span><span class="o">=</span><span class="n">cluster</span><span class="o">.</span><span class="n">norb_active</span><span class="p">,</span>
                <span class="n">converged</span><span class="o">=</span><span class="n">cluster_solver</span><span class="o">.</span><span class="n">converged</span><span class="p">,</span> <span class="n">wf</span><span class="o">=</span><span class="n">cluster_solver</span><span class="o">.</span><span class="n">wf</span><span class="p">,</span> <span class="n">pwf</span><span class="o">=</span><span class="n">pwf</span><span class="p">)</span>

        <span class="c1"># --- Correlation energy contributions</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">calc_e_wf_corr</span><span class="p">:</span>
            <span class="n">ci</span> <span class="o">=</span> <span class="n">cluster_solver</span><span class="o">.</span><span class="n">wf</span><span class="o">.</span><span class="n">as_cisd</span><span class="p">(</span><span class="n">c0</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="n">ci</span> <span class="o">=</span> <span class="n">ci</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">proj</span><span class="p">)</span>
            <span class="n">es</span><span class="p">,</span> <span class="n">ed</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">e_corr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fragment_energy</span><span class="p">(</span><span class="n">ci</span><span class="o">.</span><span class="n">c1</span><span class="p">,</span> <span class="n">ci</span><span class="o">.</span><span class="n">c2</span><span class="p">,</span> <span class="n">eris</span><span class="o">=</span><span class="n">eris</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;E(S)= </span><span class="si">%s</span><span class="s2">  E(D)= </span><span class="si">%s</span><span class="s2">  E(tot)= </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">energy_string</span><span class="p">(</span><span class="n">es</span><span class="p">),</span> <span class="n">energy_string</span><span class="p">(</span><span class="n">ed</span><span class="p">),</span>
                                                             <span class="n">energy_string</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">e_corr</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">calc_e_dm_corr</span><span class="p">:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">e_corr_dm2cumulant</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_fragment_dm2cumulant_energy</span><span class="p">(</span><span class="n">eris</span><span class="o">=</span><span class="n">eris</span><span class="p">)</span>

        <span class="c1"># Keep ERIs stored</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">store_eris</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">store_eris</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_eris</span> <span class="o">=</span> <span class="n">eris</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">eris</span>

        <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="Fragment.get_solver_options"><a class="viewcode-back" href="../../../apidoc/vayesta.ewf.html#vayesta.ewf.ewf.Fragment.get_solver_options">[docs]</a>    <span class="k">def</span> <span class="nf">get_solver_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solver</span><span class="p">):</span>
        <span class="c1"># TODO: fix this mess...</span>
        <span class="n">solver_opts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># conv_tol, solve_lambda,...:</span>
        <span class="n">solver_opts</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">solver_options</span><span class="p">)</span>
        <span class="n">pass_through</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s1">&#39;CCSD&#39;</span> <span class="ow">in</span> <span class="n">solver</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
            <span class="n">pass_through</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;sc_mode&#39;</span><span class="p">,</span> <span class="s1">&#39;dm_with_frozen&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">pass_through</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debugv</span><span class="p">(</span><span class="s2">&quot;Passing fragment option </span><span class="si">%s</span><span class="s2"> to solver.&quot;</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
            <span class="n">solver_opts</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">solver</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;TCCSD&#39;</span><span class="p">:</span>
            <span class="n">solver_opts</span><span class="p">[</span><span class="s1">&#39;tcc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># Set CAS orbitals</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">c_cas_occ</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Occupied CAS orbitals not set. Setting to occupied DMET cluster orbitals.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">c_cas_occ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dmet_bath</span><span class="o">.</span><span class="n">c_cluster_occ</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">c_cas_vir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Virtual CAS orbitals not set. Setting to virtual DMET cluster orbitals.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">c_cas_vir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dmet_bath</span><span class="o">.</span><span class="n">c_cluster_vir</span>
            <span class="n">solver_opts</span><span class="p">[</span><span class="s1">&#39;c_cas_occ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">c_cas_occ</span>
            <span class="n">solver_opts</span><span class="p">[</span><span class="s1">&#39;c_cas_vir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">c_cas_vir</span>
            <span class="n">solver_opts</span><span class="p">[</span><span class="s1">&#39;tcc_fci_opts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">tcc_fci_opts</span>
        <span class="k">elif</span> <span class="n">solver</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;DUMP&#39;</span><span class="p">:</span>
            <span class="n">solver_opts</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">solver_options</span><span class="p">[</span><span class="s1">&#39;dumpfile&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tailor_fragments</span><span class="p">:</span>
            <span class="n">solver_opts</span><span class="p">[</span><span class="s1">&#39;tailoring&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">solver_opts</span></div>

    <span class="c1"># --- Expectation values</span>
    <span class="c1"># ----------------------</span>

    <span class="c1"># --- Energies</span>

<div class="viewcode-block" id="Fragment.get_fragment_energy"><a class="viewcode-back" href="../../../apidoc/vayesta.ewf.html#vayesta.ewf.ewf.Fragment.get_fragment_energy">[docs]</a>    <span class="k">def</span> <span class="nf">get_fragment_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">eris</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fock</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">c2ba_order</span><span class="o">=</span><span class="s1">&#39;ba&#39;</span><span class="p">,</span> <span class="n">axis1</span><span class="o">=</span><span class="s1">&#39;fragment&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate fragment correlation energy contribution from projected C1, C2.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        c1 : (n(occ-CO), n(vir-CO)) array</span>
<span class="sd">            Fragment projected C1-amplitudes.</span>
<span class="sd">        c2 : (n(occ-CO), n(occ-CO), n(vir-CO), n(vir-CO)) array</span>
<span class="sd">            Fragment projected C2-amplitudes.</span>
<span class="sd">        eris : array or PySCF _ChemistERIs object</span>
<span class="sd">            Electron repulsion integrals as returned by ccsd.ao2mo().</span>
<span class="sd">        fock : (n(AO), n(AO)) array, optional</span>
<span class="sd">            Fock matrix in AO representation. If None, self.base.get_fock_for_energy()</span>
<span class="sd">            is used. Default: None.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        e_singles : float</span>
<span class="sd">            Fragment correlation energy contribution from single excitations.</span>
<span class="sd">        e_doubles : float</span>
<span class="sd">            Fragment correlation energy contribution from double excitations.</span>
<span class="sd">        e_corr : float</span>
<span class="sd">            Total fragment correlation energy contribution.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span> <span class="o">=</span> <span class="n">c2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">occ</span><span class="p">,</span> <span class="n">vir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[:</span><span class="n">nocc</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[</span><span class="n">nocc</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">axis1</span> <span class="o">==</span> <span class="s1">&#39;fragment&#39;</span><span class="p">:</span>
            <span class="n">px</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_overlap</span><span class="p">(</span><span class="s1">&#39;frag|cluster-occ&#39;</span><span class="p">)</span>

        <span class="c1"># --- Singles energy (zero for HF-reference)</span>
        <span class="k">if</span> <span class="n">c1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fock</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">get_fock_for_energy</span><span class="p">()</span>
            <span class="n">fov</span> <span class="o">=</span>  <span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">c_active_occ</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">fock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">c_active_vir</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">axis1</span> <span class="o">==</span> <span class="s1">&#39;fragment&#39;</span><span class="p">:</span>
                <span class="n">e_singles</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ia,xi,xa-&gt;&#39;</span><span class="p">,</span> <span class="n">fov</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">c1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">e_singles</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fov</span><span class="o">*</span><span class="n">c1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">e_singles</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># --- Doubles energy</span>
        <span class="k">if</span> <span class="n">eris</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">eris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eris</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">eris</span><span class="p">,</span> <span class="s1">&#39;ovvo&#39;</span><span class="p">):</span>
            <span class="n">g_ovvo</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovvo</span><span class="p">[:]</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">eris</span><span class="p">,</span> <span class="s1">&#39;ovov&#39;</span><span class="p">):</span>
            <span class="c1"># MP2 only has eris.ovov - for real integrals we transpose</span>
            <span class="n">g_ovvo</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">eris</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span><span class="p">,</span> <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span><span class="p">):</span>
            <span class="n">g_ovvo</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g_ovvo</span> <span class="o">=</span> <span class="n">eris</span><span class="p">[</span><span class="n">occ</span><span class="p">,</span><span class="n">vir</span><span class="p">,</span><span class="n">vir</span><span class="p">,</span><span class="n">occ</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">axis1</span> <span class="o">==</span> <span class="s1">&#39;fragment&#39;</span><span class="p">:</span>
            <span class="n">e_doubles</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xi,xjab,iabj&#39;</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">g_ovvo</span><span class="p">)</span>
                         <span class="o">-</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xi,xjab,ibaj&#39;</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">g_ovvo</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">e_doubles</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijab,iabj&#39;</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">g_ovvo</span><span class="p">)</span>
                         <span class="o">-</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijab,ibaj&#39;</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">g_ovvo</span><span class="p">))</span>

        <span class="n">e_singles</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sym_factor</span> <span class="o">*</span> <span class="n">e_singles</span><span class="p">)</span>
        <span class="n">e_doubles</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sym_factor</span> <span class="o">*</span> <span class="n">e_doubles</span><span class="p">)</span>
        <span class="n">e_corr</span> <span class="o">=</span> <span class="p">(</span><span class="n">e_singles</span> <span class="o">+</span> <span class="n">e_doubles</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">e_singles</span><span class="p">,</span> <span class="n">e_doubles</span><span class="p">,</span> <span class="n">e_corr</span></div>


    <span class="c1"># --- Density-matrices</span>

    <span class="k">def</span> <span class="nf">_ccsd_amplitudes_for_dm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t_as_lambda</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sym_t2</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">wf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">wf</span><span class="o">.</span><span class="n">as_ccsd</span><span class="p">()</span>
        <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="n">wf</span><span class="o">.</span><span class="n">t2</span>
        <span class="n">pwf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">pwf</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">sym</span><span class="o">=</span><span class="n">sym_t2</span><span class="p">)</span><span class="o">.</span><span class="n">as_ccsd</span><span class="p">()</span>
        <span class="n">t1x</span><span class="p">,</span> <span class="n">t2x</span> <span class="o">=</span> <span class="n">pwf</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="n">pwf</span><span class="o">.</span><span class="n">t2</span>
        <span class="c1"># Lambda amplitudes</span>
        <span class="k">if</span> <span class="n">t_as_lambda</span><span class="p">:</span>
            <span class="n">l1</span><span class="p">,</span> <span class="n">l2</span> <span class="o">=</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span>
            <span class="n">l1x</span><span class="p">,</span> <span class="n">l2x</span> <span class="o">=</span> <span class="n">t1x</span><span class="p">,</span> <span class="n">t2x</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">l1</span><span class="p">,</span> <span class="n">l2</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">l1</span><span class="p">,</span> <span class="n">wf</span><span class="o">.</span><span class="n">l2</span>
            <span class="n">l1x</span><span class="p">,</span> <span class="n">l2x</span> <span class="o">=</span> <span class="n">pwf</span><span class="o">.</span><span class="n">l1</span><span class="p">,</span> <span class="n">pwf</span><span class="o">.</span><span class="n">l2</span>
        <span class="k">return</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="p">,</span> <span class="n">t1x</span><span class="p">,</span> <span class="n">t2x</span><span class="p">,</span> <span class="n">l1x</span><span class="p">,</span> <span class="n">l2x</span>

    <span class="k">def</span> <span class="nf">_get_projected_gamma1_intermediates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t_as_lambda</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sym_t2</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="p">,</span> <span class="n">t1x</span><span class="p">,</span> <span class="n">t2x</span><span class="p">,</span> <span class="n">l1x</span><span class="p">,</span> <span class="n">l2x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ccsd_amplitudes_for_dm</span><span class="p">(</span><span class="n">t_as_lambda</span><span class="o">=</span><span class="n">t_as_lambda</span><span class="p">,</span> <span class="n">sym_t2</span><span class="o">=</span><span class="n">sym_t2</span><span class="p">)</span>
        <span class="n">doo</span><span class="p">,</span> <span class="n">dov</span><span class="p">,</span> <span class="n">dvo</span><span class="p">,</span> <span class="n">dvv</span> <span class="o">=</span> <span class="n">pyscf</span><span class="o">.</span><span class="n">cc</span><span class="o">.</span><span class="n">ccsd_rdm</span><span class="o">.</span><span class="n">_gamma1_intermediates</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">l1x</span><span class="p">,</span> <span class="n">l2x</span><span class="p">)</span>
        <span class="c1"># Correction for term without Lambda amplitude:</span>
        <span class="n">dvo</span> <span class="o">+=</span> <span class="p">(</span><span class="n">t1x</span> <span class="o">-</span> <span class="n">t1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="p">(</span><span class="n">doo</span><span class="p">,</span> <span class="n">dov</span><span class="p">,</span> <span class="n">dvo</span><span class="p">,</span> <span class="n">dvv</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">d1</span>

    <span class="k">def</span> <span class="nf">_get_projected_gamma2_intermediates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t_as_lambda</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sym_t2</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="p">,</span> <span class="n">t1x</span><span class="p">,</span> <span class="n">t2x</span><span class="p">,</span> <span class="n">l1x</span><span class="p">,</span> <span class="n">l2x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ccsd_amplitudes_for_dm</span><span class="p">(</span><span class="n">t_as_lambda</span><span class="o">=</span><span class="n">t_as_lambda</span><span class="p">,</span> <span class="n">sym_t2</span><span class="o">=</span><span class="n">sym_t2</span><span class="p">)</span>
        <span class="n">cc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mf</span> <span class="c1"># Only attributes stdout, verbose, and max_memory are needed, just use mean-field object</span>
        <span class="n">dovov</span><span class="p">,</span> <span class="o">*</span><span class="n">d2rest</span> <span class="o">=</span> <span class="n">pyscf</span><span class="o">.</span><span class="n">cc</span><span class="o">.</span><span class="n">ccsd_rdm</span><span class="o">.</span><span class="n">_gamma2_intermediates</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">l1x</span><span class="p">,</span> <span class="n">l2x</span><span class="p">)</span>
        <span class="c1"># Correct D2[ovov] part (first element of d2 tuple)</span>
        <span class="n">dtau</span> <span class="o">=</span> <span class="p">((</span><span class="n">t2x</span><span class="o">-</span><span class="n">t2</span><span class="p">)</span> <span class="o">+</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ia,jb-&gt;ijab&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">t1x</span><span class="o">-</span><span class="n">t1</span><span class="p">),</span> <span class="n">t1</span><span class="p">))</span>
        <span class="n">dovov</span> <span class="o">+=</span> <span class="n">dtau</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">dovov</span> <span class="o">-=</span> <span class="n">dtau</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="p">(</span><span class="n">dovov</span><span class="p">,</span> <span class="o">*</span><span class="n">d2rest</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">d2</span>

<div class="viewcode-block" id="Fragment.make_fragment_dm1"><a class="viewcode-back" href="../../../apidoc/vayesta.ewf.html#vayesta.ewf.ewf.Fragment.make_fragment_dm1">[docs]</a>    <span class="k">def</span> <span class="nf">make_fragment_dm1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t_as_lambda</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sym_t2</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Currently CCSD only.</span>

<span class="sd">        Without mean-field contribution!&quot;&quot;&quot;</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_projected_gamma1_intermediates</span><span class="p">(</span><span class="n">t_as_lambda</span><span class="o">=</span><span class="n">t_as_lambda</span><span class="p">,</span> <span class="n">sym_t2</span><span class="o">=</span><span class="n">sym_t2</span><span class="p">)</span>
        <span class="n">dm1</span> <span class="o">=</span> <span class="n">pyscf</span><span class="o">.</span><span class="n">cc</span><span class="o">.</span><span class="n">ccsd_rdm</span><span class="o">.</span><span class="n">_make_rdm1</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">d1</span><span class="p">,</span> <span class="n">with_frozen</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">with_mf</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dm1</span></div>

<div class="viewcode-block" id="Fragment.make_fragment_dm2cumulant"><a class="viewcode-back" href="../../../apidoc/vayesta.ewf.html#vayesta.ewf.ewf.Fragment.make_fragment_dm2cumulant">[docs]</a>    <span class="k">def</span> <span class="nf">make_fragment_dm2cumulant</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t_as_lambda</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sym_t2</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sym_dm2</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">full_shape</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">approx_cumulant</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Currently MP2/CCSD only&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">==</span> <span class="s1">&#39;MP2&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">approx_cumulant</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span>
            <span class="n">t2x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">pwf</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">sym</span><span class="o">=</span><span class="n">sym_t2</span><span class="p">)</span><span class="o">.</span><span class="n">as_ccsd</span><span class="p">()</span><span class="o">.</span><span class="n">t2</span>
            <span class="n">dovov</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">t2x</span> <span class="o">-</span> <span class="n">t2x</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">full_shape</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">dovov</span>
            <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span> <span class="o">=</span> <span class="n">dovov</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">norb</span> <span class="o">=</span> <span class="n">nocc</span><span class="o">+</span><span class="n">nvir</span>
            <span class="n">dm2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="p">[</span><span class="n">norb</span><span class="p">])</span>
            <span class="n">occ</span><span class="p">,</span> <span class="n">vir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[:</span><span class="n">nocc</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[</span><span class="n">nocc</span><span class="p">:]</span>
            <span class="n">dm2</span><span class="p">[</span><span class="n">occ</span><span class="p">,</span><span class="n">vir</span><span class="p">,</span><span class="n">occ</span><span class="p">,</span><span class="n">vir</span><span class="p">]</span> <span class="o">=</span> <span class="n">dovov</span>
            <span class="n">dm2</span><span class="p">[</span><span class="n">vir</span><span class="p">,</span><span class="n">occ</span><span class="p">,</span><span class="n">vir</span><span class="p">,</span><span class="n">occ</span><span class="p">]</span> <span class="o">=</span> <span class="n">dovov</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dm2</span>

        <span class="n">cc</span> <span class="o">=</span> <span class="n">d1</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_projected_gamma2_intermediates</span><span class="p">(</span><span class="n">t_as_lambda</span><span class="o">=</span><span class="n">t_as_lambda</span><span class="p">,</span> <span class="n">sym_t2</span><span class="o">=</span><span class="n">sym_t2</span><span class="p">)</span>
        <span class="n">dm2</span> <span class="o">=</span> <span class="n">pyscf</span><span class="o">.</span><span class="n">cc</span><span class="o">.</span><span class="n">ccsd_rdm</span><span class="o">.</span><span class="n">_make_rdm2</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">with_dm1</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">with_frozen</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">approx_cumulant</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">approx_cumulant</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">)):</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">approx_cumulant</span><span class="p">:</span>
            <span class="c1"># Remove dm1(cc)^2</span>
            <span class="n">dm1x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_fragment_dm1</span><span class="p">(</span><span class="n">t_as_lambda</span><span class="o">=</span><span class="n">t_as_lambda</span><span class="p">,</span> <span class="n">sym_t2</span><span class="o">=</span><span class="n">sym_t2</span><span class="p">)</span>
            <span class="n">dm1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">wf</span><span class="o">.</span><span class="n">make_rdm1</span><span class="p">(</span><span class="n">with_mf</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">dm2</span> <span class="o">-=</span> <span class="p">(</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,kl-&gt;ijkl&#39;</span><span class="p">,</span> <span class="n">dm1</span><span class="p">,</span> <span class="n">dm1x</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,kl-&gt;ijkl&#39;</span><span class="p">,</span> <span class="n">dm1x</span><span class="p">,</span> <span class="n">dm1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
                  <span class="o">-</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,kl-&gt;iklj&#39;</span><span class="p">,</span> <span class="n">dm1</span><span class="p">,</span> <span class="n">dm1x</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span> <span class="o">-</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,kl-&gt;iklj&#39;</span><span class="p">,</span> <span class="n">dm1x</span><span class="p">,</span> <span class="n">dm1</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">sym_dm2</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">sym_t2</span><span class="p">):</span>
            <span class="n">dm2</span> <span class="o">=</span> <span class="p">(</span><span class="n">dm2</span> <span class="o">+</span> <span class="n">dm2</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">dm2</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">dm2</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span><span class="o">/</span><span class="mi">4</span>
        <span class="k">return</span> <span class="n">dm2</span></div>

    <span class="c1">#def make_partial_dm1_energy(self, t_as_lambda=False):</span>
    <span class="c1">#    dm1 = self.make_partial_dm1(t_as_lambda=t_as_lambda)</span>
    <span class="c1">#    c_act = self.cluster.c_active</span>
    <span class="c1">#    fock = np.linalg.multi_dot((c_act.T, self.base.get_fock(), c_act))</span>
    <span class="c1">#    e_dm1 = einsum(&#39;ij,ji-&gt;&#39;, fock, dm1)</span>
    <span class="c1">#    return e_dm1</span>

<div class="viewcode-block" id="Fragment.make_fragment_dm2cumulant_energy"><a class="viewcode-back" href="../../../apidoc/vayesta.ewf.html#vayesta.ewf.ewf.Fragment.make_fragment_dm2cumulant_energy">[docs]</a>    <span class="nd">@log_method</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">make_fragment_dm2cumulant_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eris</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t_as_lambda</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sym_t2</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">approx_cumulant</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">eris</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">eris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eris</span>
        <span class="k">if</span> <span class="n">eris</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">eris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">get_eris_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">c_active</span><span class="p">)</span>
        <span class="n">dm2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_fragment_dm2cumulant</span><span class="p">(</span><span class="n">t_as_lambda</span><span class="o">=</span><span class="n">t_as_lambda</span><span class="p">,</span> <span class="n">sym_t2</span><span class="o">=</span><span class="n">sym_t2</span><span class="p">,</span> <span class="n">approx_cumulant</span><span class="o">=</span><span class="n">approx_cumulant</span><span class="p">,</span>
                <span class="n">full_shape</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># CCSD</span>
        <span class="c1"># TODO: contract intermediates (see UHF version)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">eris</span><span class="p">,</span> <span class="s1">&#39;ovoo&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">vayesta</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">ao2mo</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">contract_dm2_eris</span><span class="p">(</span><span class="n">dm2</span><span class="p">,</span> <span class="n">eris</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">fac</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">==</span> <span class="s1">&#39;MP2&#39;</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">e_dm2</span> <span class="o">=</span> <span class="n">fac</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijkl,ijkl-&gt;&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="p">,</span> <span class="n">dm2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
        <span class="k">return</span> <span class="n">e_dm2</span></div>

    <span class="c1"># --- Other</span>
    <span class="c1"># ---------</span>

<div class="viewcode-block" id="Fragment.get_fragment_bsse"><a class="viewcode-back" href="../../../apidoc/vayesta.ewf.html#vayesta.ewf.ewf.Fragment.get_fragment_bsse">[docs]</a>    <span class="k">def</span> <span class="nf">get_fragment_bsse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nimages</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Counterpoise Calculation&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;************************&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">bsse_rmax</span>

        <span class="c1"># Atomic calculation with atomic basis functions:</span>
        <span class="c1">#mol = self.mol.copy()</span>
        <span class="c1">#atom = mol.atom[self.atoms]</span>
        <span class="c1">#self.log.debugv(&quot;Keeping atoms %r&quot;, atom)</span>
        <span class="c1">#mol.atom = atom</span>
        <span class="c1">#mol.a = None</span>
        <span class="c1">#mol.build(False, False)</span>

        <span class="n">natom0</span><span class="p">,</span> <span class="n">e_mf0</span><span class="p">,</span> <span class="n">e_cm0</span><span class="p">,</span> <span class="n">dm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">counterpoise_calculation</span><span class="p">(</span><span class="n">rmax</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">nimages</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">natom0</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debugv</span><span class="p">(</span><span class="s2">&quot;Counterpoise: E(atom)= </span><span class="si">% 16.8f</span><span class="s2"> Ha&quot;</span><span class="p">,</span> <span class="n">e_cm0</span><span class="p">)</span>

        <span class="c1">#natom_list = []</span>
        <span class="c1">#e_mf_list = []</span>
        <span class="c1">#e_cm_list = []</span>
        <span class="n">r_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">rmax</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">rmax</span><span class="p">))</span>
        <span class="c1">#for r in r_values:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">rmax</span>
        <span class="n">natom</span><span class="p">,</span> <span class="n">e_mf</span><span class="p">,</span> <span class="n">e_cm</span><span class="p">,</span> <span class="n">dm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">counterpoise_calculation</span><span class="p">(</span><span class="n">rmax</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">dm0</span><span class="o">=</span><span class="n">dm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debugv</span><span class="p">(</span><span class="s2">&quot;Counterpoise: n(atom)= </span><span class="si">%3d</span><span class="s2">  E(mf)= </span><span class="si">%16.8f</span><span class="s2"> Ha  E(</span><span class="si">%s</span><span class="s2">)= </span><span class="si">% 16.8f</span><span class="s2"> Ha&quot;</span><span class="p">,</span> <span class="n">natom</span><span class="p">,</span> <span class="n">e_mf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="p">,</span> <span class="n">e_cm</span><span class="p">)</span>

        <span class="n">e_bsse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sym_factor</span><span class="o">*</span><span class="p">(</span><span class="n">e_cm</span> <span class="o">-</span> <span class="n">e_cm0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debugv</span><span class="p">(</span><span class="s2">&quot;Counterpoise: E(BSSE)= </span><span class="si">% 16.8f</span><span class="s2"> Ha&quot;</span><span class="p">,</span> <span class="n">e_bsse</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">e_bsse</span></div>

<div class="viewcode-block" id="Fragment.counterpoise_calculation"><a class="viewcode-back" href="../../../apidoc/vayesta.ewf.html#vayesta.ewf.ewf.Fragment.counterpoise_calculation">[docs]</a>    <span class="k">def</span> <span class="nf">counterpoise_calculation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rmax</span><span class="p">,</span> <span class="n">dm0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nimages</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">):</span>
        <span class="n">mol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_counterpoise_mol</span><span class="p">(</span><span class="n">rmax</span><span class="p">,</span> <span class="n">nimages</span><span class="o">=</span><span class="n">nimages</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s1">&#39;pyscf-cp.txt&#39;</span><span class="p">)</span>
        <span class="c1"># Mean-field</span>
        <span class="c1">#mf = type(self.mf)(mol)</span>
        <span class="n">mf</span> <span class="o">=</span> <span class="n">pyscf</span><span class="o">.</span><span class="n">scf</span><span class="o">.</span><span class="n">RHF</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
        <span class="n">mf</span><span class="o">.</span><span class="n">conv_tol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="o">.</span><span class="n">conv_tol</span>
        <span class="c1">#if self.mf.with_df is not None:</span>
        <span class="c1">#    self.log.debugv(&quot;Setting GDF&quot;)</span>
        <span class="c1">#    self.log.debugv(&quot;%s&quot;, type(self.mf.with_df))</span>
        <span class="c1">#    # ONLY GDF SO FAR!</span>
        <span class="c1"># TODO: generalize</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">kdf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">auxbasis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">kdf</span><span class="o">.</span><span class="n">auxbasis</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="o">.</span><span class="n">with_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">auxbasis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="o">.</span><span class="n">with_df</span><span class="o">.</span><span class="n">auxbasis</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">auxbasis</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">if</span> <span class="n">auxbasis</span><span class="p">:</span>
            <span class="n">mf</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">density_fit</span><span class="p">(</span><span class="n">auxbasis</span><span class="o">=</span><span class="n">auxbasis</span><span class="p">)</span>
        <span class="c1"># TODO:</span>
        <span class="c1">#use dm0 as starting point</span>
        <span class="n">mf</span><span class="o">.</span><span class="n">kernel</span><span class="p">()</span>
        <span class="n">dm0</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">make_rdm1</span><span class="p">()</span>
        <span class="c1"># Embedded calculation with same options</span>
        <span class="n">ecc</span> <span class="o">=</span> <span class="n">ewf</span><span class="o">.</span><span class="n">EWF</span><span class="p">(</span><span class="n">mf</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="p">,</span> <span class="n">bno_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bno_threshold</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">opts</span><span class="p">)</span>
        <span class="n">ecc</span><span class="o">.</span><span class="n">make_atom_cluster</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">)</span>
        <span class="n">ecc</span><span class="o">.</span><span class="n">kernel</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">mol</span><span class="o">.</span><span class="n">natm</span><span class="p">,</span> <span class="n">mf</span><span class="o">.</span><span class="n">e_tot</span><span class="p">,</span> <span class="n">ecc</span><span class="o">.</span><span class="n">e_tot</span><span class="p">,</span> <span class="n">dm0</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>